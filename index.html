<!doctype html>
<html lang="ca">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>FisQuim Quest ‚Äî Apr√®n jugant</title>
  <meta name="description" content="FisQuim Quest: apunts, jocs i problemes sobre concentracions i dissolucions. Catal√†/CAST.">
  <style>
    /* ===========================
       VARIABLES I GLOBALS
       =========================== */
    :root{
      --bg1: #f4f7ff;
      --bg2: #ecf1ff;
      --card: #ffffff;
      --text: #172033;
      --muted: #6b7280;
      --accent: #4d6bff;
      --accent2: #5dd4c6;
      --border: #e6eefc;
      --radius: 12px;
      --shadow: 0 8px 26px rgba(16,24,40,0.06);
      --glass: rgba(255,255,255,0.6);
      --transition: 240ms ease;
      --accent-gradient: linear-gradient(90deg,var(--accent),var(--accent2));
    }
    body.dark{
      --bg1: #0f1117;
      --bg2: #12131a;
      --card: #161820;
      --text: #e9eefc;
      --muted: #9aa1b8;
      --border: #212329;
      --glass: rgba(255,255,255,0.03);
      --shadow: 0 8px 28px rgba(0,0,0,0.5);
    }

    *{box-sizing:border-box;margin:0;padding:0}
    html,body{height:100%}
    body{
      font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      background: linear-gradient(180deg,var(--bg1),var(--bg2));
      color:var(--text);
      transition: background var(--transition), color var(--transition);
      -webkit-font-smoothing:antialiased;
      padding-bottom:80px;
    }

    /* layout */
    header{position:sticky;top:10px;z-index:60;margin:10px;display:flex;align-items:center;gap:12px;padding:12px;border-radius:12px;background:var(--card);box-shadow:var(--shadow);border:1px solid var(--border)}
    .logo{display:flex;gap:12px;align-items:center}
    .logo-mark{width:56px;height:56px;border-radius:12px;background:var(--accent-gradient);display:flex;align-items:center;justify-content:center;color:white;font-weight:800;cursor:pointer;box-shadow:0 10px 30px rgba(77,107,255,0.12);transition:transform .18s}
    .logo-mark:hover{transform:translateY(-4px) scale(1.02)}
    .title-small{font-size:13px;color:var(--muted)}

    nav{margin-left:auto;display:flex;gap:8px;align-items:center}
    nav button{background:transparent;border:1px solid transparent;padding:8px 12px;border-radius:10px;cursor:pointer;font-weight:700;transition:all var(--transition)}
    nav button.active{background:var(--accent-gradient);color:white;box-shadow:0 10px 26px rgba(77,107,255,0.12)}
    .lang-switch{border-radius:8px;padding:6px 8px;border:1px solid var(--border);cursor:pointer;background:var(--card);margin-left:8px}

    .container{max-width:1150px;margin:14px auto;padding:12px}
    .grid{display:grid;grid-template-columns:1fr 360px;gap:14px}
    @media(max-width:980px){.grid{grid-template-columns:1fr}}

    .card{background:var(--card);border-radius:12px;padding:12px;border:1px solid var(--border);box-shadow:var(--shadow);transition:transform .15s ease}
    .card:hover{transform:translateY(-6px)}
    .small{font-size:13px;color:var(--muted)}

    .btn{background:var(--accent-gradient);color:white;border:none;padding:8px 12px;border-radius:10px;cursor:pointer;font-weight:700;box-shadow:0 8px 26px rgba(77,107,255,0.08)}
    .btn.ghost{background:transparent;border:1px solid var(--border);color:var(--text)}
    .btn.secondary{background:transparent;border:1px solid var(--accent);color:var(--accent)}
    input[type="text"], input[type="number"], textarea{padding:8px;border-radius:8px;border:1px solid var(--border);width:100%;background:var(--glass);color:var(--text)}
    pre{background:rgba(0,0,0,0.03);padding:8px;border-radius:8px;overflow:auto}

    section{display:none}
    section.active{display:block}

    /* games */
    .game-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px}
    .game-tile{cursor:pointer;padding:12px;border-radius:10px;border:1px solid var(--border);background:linear-gradient(180deg,rgba(255,255,255,0.02),transparent)}
    .game-tile h3{margin-bottom:4px}
    #gameArea{margin-top:12px}

    /* drag & drop */
    .match-wrap{display:flex;gap:12px;flex-wrap:wrap}
    .col{flex:1;min-width:200px}
    .match-box{min-height:56px;border-radius:10px;padding:10px;border:2px dashed var(--border);transition:background .12s}
    .match-box.dragover{background:linear-gradient(90deg,rgba(77,107,255,0.06),rgba(93,212,198,0.03))}
    .draggable{padding:8px;border-radius:8px;border:1px solid var(--border);background:var(--card);margin-bottom:8px;cursor:grab}

    /* memory */
    .board{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
    .tile{background:linear-gradient(180deg,#fff,#f7fbff);padding:14px;border-radius:10px;font-weight:800;display:flex;align-items:center;justify-content:center;cursor:pointer;min-height:70px;transition:transform .12s,background .12s}
    .tile.revealed{background:var(--accent-gradient);color:white;transform:scale(1.03)}

    /* achievements */
    .ach-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:10px}
    .ach{display:flex;gap:10px;align-items:center;padding:10px;border-radius:10px;border:1px solid var(--border);background:linear-gradient(180deg,rgba(255,255,255,0.02),transparent)}
    .ach.locked{opacity:.35}
    .ach .icon{width:44px;height:44px;border-radius:10px;background:var(--accent-gradient);display:flex;align-items:center;justify-content:center;color:white;font-weight:800}

    /* palette preview */
    .palette-preview{padding:6px 10px;border-radius:999px;color:white;font-weight:800;display:inline-block;margin-right:8px}

    .hint{font-size:13px;color:var(--muted);margin-top:6px}

    /* animations */
    .float{animation:floaty 3s ease-in-out infinite}
    @keyframes floaty{0%{transform:translateY(0)}50%{transform:translateY(-6px)}100%{transform:translateY(0)}}

  </style>
</head>
<body>
  <!-- ================= HEADER + NAV ================= -->
  <header>
    <div class="logo">
      <div class="logo-mark" id="logoMark" title="Fes clic per buscar secrets">FQ</div>
      <div>
        <div style="font-weight:900" id="titleTxt">FisQuim Quest</div>
        <div class="title-small" id="subtitleTxt">Apr√®n dissolucions jugant</div>
      </div>
    </div>

    <nav id="mainNav">
      <button data-target="apunts" class="active">üìò Apunts</button>
      <button data-target="jocs">üéÆ Jocs</button>
      <button data-target="problemes">üß™ Problemes</button>
      <button data-target="logros">üèÜ Logros</button>
      <button data-target="config">‚öôÔ∏è Config</button>
      <select id="langSelect" class="lang-switch" title="Canvia idioma" aria-label="Idioma">
        <option value="ca">Catal√†</option>
        <option value="es">Castell√†</option>
      </select>
    </nav>
  </header>

  <!-- ================= MAIN LAYOUT ================= -->
  <main class="container">
    <div class="grid">
      <!-- MAIN COLUMN -->
      <div>
        <!-- APUNTS -->
        <section id="apunts" class="active">
          <div class="card">
            <h2 id="headingNotes">üìò Apunts ‚Äî Dissolucions i concentracions</h2>
            <p class="small" id="notesIntro">Explicacions clares i resumides per 3r d'ESO. Llegir i practicar amb els jocs/respostes.</p>
          </div>

          <div class="card">
            <h3 id="s1">1Ô∏è‚É£ Qu√® √©s una dissoluci√≥?</h3>
            <p id="s1p">Una <b>dissoluci√≥</b> √©s una barreja homog√®nia: exemple, sucre dissolt en aigua.</p>
            <ul>
              <li><b id="termSolut">Solut</b>: subst√†ncia que es dissol (ex. sal).</li>
              <li><b id="termDissolvent">Dissolvent</b>: el l√≠quid que dissolveix (normalment aigua).</li>
            </ul>
            <p class="small">Truc: el solut √©s el que n'hi ha menys; el dissolvent, el que n'hi ha m√©s.</p>
          </div>

          <div class="card">
            <h3 id="s2">2Ô∏è‚É£ Tipus de concentracions</h3>
            <h4>g/L</h4>
            <p>Indica quants grams de solut hi ha per cada litre de dissoluci√≥.</p>
            <pre>g/L = grams de solut √∑ litres de dissoluci√≥</pre>
            <p class="small">Recorda convertir ml ‚Üí L (divideix per 1000).</p>

            <h4>% en massa</h4>
            <pre>% = (massa solut √∑ massa total) √ó 100</pre>
            <p class="small">Massa total = solut + dissolvent.</p>

            <h4>% en volum</h4>
            <pre>% = (volum solut √∑ volum total) √ó 100</pre>
          </div>

          <div class="card">
            <h3 id="s3">3Ô∏è‚É£ Exercicis r√†pids</h3>
            <div style="display:flex;gap:8px;flex-wrap:wrap">
              <input id="g1" type="number" placeholder="grams solut (ex. 30)">
              <input id="v1" type="number" placeholder="ml dissoluci√≥ (ex. 600)">
              <button class="btn" id="btnCalcGL">Calcula g/L</button>
            </div>
            <div id="res1" class="small" style="margin-top:8px"></div>

            <div style="height:10px"></div>

            <div style="display:flex;gap:8px;flex-wrap:wrap">
              <input id="sm1" type="number" placeholder="g solut">
              <input id="dm1" type="number" placeholder="g dissolvent">
              <button class="btn" id="btnCalcPct">Calcula % massa</button>
            </div>
            <div id="res2" class="small" style="margin-top:8px"></div>

            <p class="hint" style="margin-top:10px">Consell: fes pas a pas: identifica, converteix unitats, aplica la f√≥rmula.</p>
          </div>

        </section>

        <!-- JOCS -->
        <section id="jocs">
          <div class="card">
            <h2>üéÆ Jocs</h2>
            <p class="small">Jocs pensats per practicar teoria i c√†lculs.</p>
          </div>

          <div class="game-grid">
            <div class="game-tile card" id="tileCalc"><h3>üßÆ R√†fega de c√†lculs</h3><p class="small">Respon preg. g/L, %...</p></div>
            <div class="game-tile card" id="tileMatch"><h3>üîó Arrossega i relaciona</h3><p class="small">Drag & drop ben funcionant</p></div>
            <div class="game-tile card" id="tileLab"><h3>‚öó Laboratori</h3><p class="small">Prepara una dissoluci√≥ amb objectiu</p></div>
            <div class="game-tile card" id="tileMemory"><h3>üß† Memory educatiu</h3><p class="small">Parelles de conceptes</p></div>
            <div class="game-tile card" id="tileTimed"><h3>‚è± Repte cronometrat</h3><p class="small">5 preguntes en 60s</p></div>
            <div class="game-tile card" id="tileFill"><h3>‚úçÔ∏è Omple els buits</h3><p class="small">Practica definicions</p></div>
          </div>

          <div id="gameArea" style="margin-top:12px"></div>
        </section>

        <!-- PROBLEMES -->
        <section id="problemes">
          <div class="card"><h2>üß™ Problemes reals (Ex√†mens)</h2><p class="small">Problemes pas a pas. Intenta abans de veure la soluci√≥.</p></div>
          <div id="problemesArea"></div>
        </section>

        <!-- LOGROS -->
        <section id="logros">
          <div class="card"><h2>üèÜ Logros</h2><p class="small">A dalt tens el total; aqu√≠ la llista de tots.</p></div>
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
            <div><b>Desbloquejats:</b> <span id="countUnlocked">0</span> / <span id="countTotal">0</span></div>
            <div class="small">Explora la web per aconseguir m√©s</div>
          </div>
          <div class="ach-grid" id="achGrid"></div>
        </section>

        <!-- CONFIG -->
        <section id="config">
          <div class="card"><h2>‚öôÔ∏è Configuraci√≥</h2>
            <div style="display:flex;gap:8px;align-items:center">
              <button class="btn" id="toggleDark">üåô Mode fosc / clar</button>
              <div style="flex:1"></div>
              <div class="small">Idioma:</div>
              <select id="langSmall" class="lang-switch" style="margin-left:8px;width:120px">
                <option value="ca">Catal√†</option>
                <option value="es">Castell√†</option>
              </select>
            </div>

            <div style="margin-top:12px">
              <h4>Paletes</h4>
              <div style="display:flex;gap:12px;align-items:center">
                <div>
                  <div class="palette-preview" id="preview-default" style="background:linear-gradient(90deg,#4d6bff,#5dd4c6)">DEF</div>
                  <div style="margin-top:6px"><button class="btn ghost" data-palette="default">Aplica</button></div>
                </div>
                <div>
                  <div class="palette-preview" id="preview-menta" style="background:linear-gradient(90deg,#48d8b4,#7afbe6)">MENTA</div>
                  <div style="margin-top:6px"><button class="btn ghost" data-palette="menta">Aplica</button></div>
                </div>
                <div>
                  <div class="palette-preview" id="preview-magma" style="background:linear-gradient(90deg,#ff5a3d,#ffb36e)">MAGMA</div>
                  <div style="margin-top:6px"><button class="btn ghost" data-palette="magma">Aplica</button></div>
                </div>
              </div>
              <p class="hint">Les paletes canvien botons, fons degradat i accents tant en clar com en fosc.</p>
            </div>
          </div>
        </section>
      </div>

      <!-- SIDEBAR -->
      <aside>
        <div class="card">
          <h3 id="statusTitle">Estat</h3>
          <p class="small">Punts: <b id="points">0</b></p>
          <p class="small">Racha: <b id="streak">0</b></p>
          <p class="small">Secrets: <b id="secrets">0</b></p>
        </div>

        <div class="card" style="margin-top:12px">
          <h4>Accions r√†pides</h4>
          <div style="display:flex;gap:8px;flex-wrap:wrap">
            <button class="btn ghost" id="quickPractice">Practica</button>
            <button class="btn ghost" id="gotoProblems">Problemes</button>
            <button class="btn ghost" id="viewAchievements">Logros</button>
          </div>
        </div>
      </aside>
    </div>
  </main>

  <!-- ========================= SCRIPT (MOLT IMPORTANT) ========================= -->
  <script>
/* ======== ESTAT I CONFIG ======== */
const STORE_PREFIX = 'fq_v1_'; // prefix per localStorage
let state = {
  points: Number(localStorage.getItem(STORE_PREFIX+'points') || 0),
  streak: Number(localStorage.getItem(STORE_PREFIX+'streak') || 0),
  secrets: Number(localStorage.getItem(STORE_PREFIX+'secrets') || 0),
  achievements: JSON.parse(localStorage.getItem(STORE_PREFIX+'ach') || '{}'),
  palette: localStorage.getItem(STORE_PREFIX+'palette') || 'default',
  lang: localStorage.getItem(STORE_PREFIX+'lang') || 'ca'
};

/* ======== TRADUCCIONS (CA / ES) ========
   Nom√©s hi ha textos din√†mics: t√≠tols, botons i textos curts.
   Les seccions d'apunts i problemes tamb√© tenen variant espanyola.
*/
const T = {
  ca: {
    title: 'FisQuim Quest',
    subtitle: 'Apr√®n dissolucions jugant',
    notesIntro: "Explicacions clares i resumides per 3r d'ESO.",
    status: "Estat",
    actions: "Accions r√†pides",
    // buttons
    btnCalculate: "Calcula g/L",
    btnPct: "Calcula % massa",
    // messages
    toastFoundEgg: "Easter egg trobat! üéâ",
    toastSecret: "Secret avan√ßat desblocat! ‚ú®"
  },
  es: {
    title: 'FisQuim Quest',
    subtitle: 'Aprende disoluciones jugando',
    notesIntro: "Explicaciones claras y resumidas para 3¬∫ ESO.",
    status: "Estado",
    actions: "Acciones r√°pidas",
    btnCalculate: "Calcula g/L",
    btnPct: "Calcula % masa",
    toastFoundEgg: "¬°Easter egg encontrado! üéâ",
    toastSecret: "¬°Secreto avanzado desbloqueado! ‚ú®"
  }
};

/* ======== ACHIEVEMENTS DEFINICI√ì ======== */
const ACH_META = {
  readNotes: {id:'readNotes', name_ca:'Lector', name_es:'Lector', desc_ca:'Has obert els apunts', desc_es:'Has abierto los apuntes', icon:'üìò'},
  quickCalc: {id:'quickCalc', name_ca:'C√†lculs', name_es:'C√°lculos', desc_ca:'10 c√†lculs encertats', desc_es:'10 c√°lculos acertados', icon:'üßÆ'},
  matchMaster: {id:'matchMaster', name_ca:'Relacions', name_es:'Relaciones', desc_ca:'Completes drag&drop', desc_es:'Completaste drag&drop', icon:'üîó'},
  labWizard: {id:'labWizard', name_ca:'Laboratori', name_es:'Laboratorio', desc_ca:'Has preparat una dissoluci√≥', desc_es:'Has preparado una disoluci√≥n', icon:'‚öóÔ∏è'},
  problemSolver: {id:'problemSolver', name_ca:'Problemes', name_es:'Problemas', desc_ca:'Resolt 5 problemes', desc_es:'Resuelto 5 problemas', icon:'üß™'},
  explorer: {id:'explorer', name_ca:'Explorador', name_es:'Explorador', desc_ca:'Has visitat totes les seccions', desc_es:'Has visitado todas las secciones', icon:'üß≠'},
  easterEgg: {id:'easterEgg', name_ca:'Ca√ßador d\'ous', name_es:'Cazador de huevos', desc_ca:'Has trobat un easter egg', desc_es:'Has encontrado un easter egg', icon:'ü•ö'},
  secretClick: {id:'secretClick', name_ca:'Click misteri√≥s', name_es:'Click misterioso', desc_ca:'Has clicat 10 vegades el logo', desc_es:'Has clicado 10 veces el logo', icon:'‚ú®'},
  nightOwl: {id:'nightOwl', name_ca:'B√∫ho nocturn', name_es:'B√∫ho nocturno', desc_ca:'Has activat mode fosc', desc_es:'Has activado modo oscuro', icon:'üåô'},
  paletteStylist: {id:'paletteStylist', name_ca:'Estilista', name_es:'Estilista', desc_ca:'Has aplicat una paleta', desc_es:'Has aplicado una paleta', icon:'üé®'},
  speedy: {id:'speedy', name_ca:'R√†pid', name_es:'R√°pido', desc_ca:'Resol en <10s', desc_es:'Resuelve en <10s', icon:'‚ö°'}
};

/* initialize achievements store if empty */
for(let k in ACH_META){
  if(!state.achievements[k]) state.achievements[k] = {unlocked:false, times:0};
}

/* ======== HELPERS: save/load state ======== */
function saveState(){
  localStorage.setItem(STORE_PREFIX+'points', state.points);
  localStorage.setItem(STORE_PREFIX+'streak', state.streak);
  localStorage.setItem(STORE_PREFIX+'secrets', state.secrets);
  localStorage.setItem(STORE_PREFIX+'ach', JSON.stringify(state.achievements));
  localStorage.setItem(STORE_PREFIX+'palette', state.palette);
  localStorage.setItem(STORE_PREFIX+'lang', state.lang);
}

/* ======== UI: language switching ======== */
const langSelect = document.getElementById('langSelect');
const langSmall = document.getElementById('langSmall');
function applyLanguage(){
  const L = state.lang;
  // set selects
  langSelect.value = L;
  langSmall.value = L;
  // set dynamic texts
  document.getElementById('titleTxt').innerText = T[L].title;
  document.getElementById('subtitleTxt').innerText = T[L].subtitle;
  document.getElementById('notesIntro').innerText = T[L].notesIntro;
  document.getElementById('statusTitle').innerText = T[L].status;
  // buttons text where needed (we only have generic ones)
  document.getElementById('btnCalcGL').innerText = T[L].btnCalculate;
  document.getElementById('btnCalcPct').innerText = T[L].btnPct;
}
langSelect.addEventListener('change', e => { state.lang = e.target.value; saveState(); applyLanguage(); });
langSmall.addEventListener('change', e => { state.lang = e.target.value; saveState(); applyLanguage(); });

/* ======== NAVIGATION ======== */
const navButtons = document.querySelectorAll('nav button[data-target]');
function showSection(id){
  document.querySelectorAll('main section').forEach(s=> s.classList.remove('active'));
  const sec = document.getElementById(id);
  if(sec) sec.classList.add('active');
  // active nav button
  navButtons.forEach(b => b.classList.toggle('active', b.dataset.target === id));
  // mark visited for explorer achievement
  localStorage.setItem(STORE_PREFIX+'visited_'+id, '1');
  checkExplorer();
}
navButtons.forEach(b => b.addEventListener('click', ()=> showSection(b.dataset.target)));
document.getElementById('quickPractice').addEventListener('click', ()=> showSection('jocs'));
document.getElementById('gotoProblems').addEventListener('click', ()=> showSection('problemes'));
document.getElementById('viewAchievements').addEventListener('click', ()=> showSection('logros'));

/* first view */
showSection('apunts');

/* ======== UTILS: awards and achievements ======== */
function unlock(key){
  if(!state.achievements[key]) state.achievements[key] = {unlocked:false,times:0};
  if(!state.achievements[key].unlocked){
    state.achievements[key].unlocked = true;
  }
  state.achievements[key].times = (state.achievements[key].times||0) + 1;
  saveState();
  renderAchievements();
}
function awardPoints(n){ state.points += n; state.streak += 1; saveState(); renderStatus(); }
function resetStreak(){ state.streak = 0; saveState(); renderStatus(); }

function renderStatus(){
  document.getElementById('points').innerText = state.points;
  document.getElementById('streak').innerText = state.streak;
  document.getElementById('secrets').innerText = state.secrets;
}
renderStatus();

/* ======== RENDER ACHIEVEMENTS ======== */
function renderAchievements(){
  const grid = document.getElementById('achGrid');
  grid.innerHTML = '';
  let unlocked = 0, total = 0;
  for(let k in ACH_META){
    total++;
    const meta = ACH_META[k];
    const st = state.achievements[k] || {unlocked:false,times:0};
    if(st.unlocked) unlocked++;
    const div = document.createElement('div');
    div.className = 'ach' + (st.unlocked ? '' : ' locked');
    div.innerHTML = `
      <div class="icon">${meta.icon}</div>
      <div style="flex:1">
        <div style="font-weight:800">${state.lang==='ca'?meta.name_ca:meta.name_es}</div>
        <div class="small">${state.lang==='ca'?meta.desc_ca:meta.desc_es}</div>
      </div>
      <div style="text-align:right">
        <div class="small">vegades</div>
        <div style="font-weight:800">${st.times||0}</div>
      </div>`;
    grid.appendChild(div);
  }
  document.getElementById('countUnlocked').innerText = unlocked;
  document.getElementById('countTotal').innerText = total;
}
renderAchievements();

/* ======== EASTER EGGS & SECRETS ======== */
let logoClicks = 0;
document.getElementById('logoMark').addEventListener('click', ()=>{
  logoClicks++;
  if(logoClicks === 5){
    state.secrets++; saveState(); renderStatus();
    unlock('easterEgg'); alert(T[state.lang].toastFoundEgg);
  } else if(logoClicks === 10){
    unlock('secretClick'); alert(T[state.lang].toastSecret);
  }
  setTimeout(()=> logoClicks = 0, 4000);
});
document.addEventListener('keydown', (e) => { if(e.ctrlKey && e.key.toLowerCase()==='k'){ unlock('explorer'); alert('Mapa secret obert!'); } });

/* ======== PALETTES: aplicaci√≥ en CLAR i FOSC ======== */
function setPalette(p){
  state.palette = p; localStorage.setItem(STORE_PREFIX+'palette', p);
  let bg1,bg2,accent,accent2;
  if(p==='menta'){ bg1='#e6fbf7'; bg2='#d3fff6'; accent='#48d8b4'; accent2='#7afbe6'; }
  else if(p==='magma'){ bg1='#fff3ee'; bg2='#fff6ec'; accent='#ff5a3d'; accent2='#ffb36e'; }
  else { bg1='#f4f7ff'; bg2='#ecf1ff'; accent='#4d6bff'; accent2='#5dd4c6'; }
  document.documentElement.style.setProperty('--bg1', bg1);
  document.documentElement.style.setProperty('--bg2', bg2);
  document.documentElement.style.setProperty('--accent', accent);
  document.documentElement.style.setProperty('--accent2', accent2);
  document.documentElement.style.setProperty('--accent-gradient', `linear-gradient(90deg, ${accent}, ${accent2})`);
  // force background update for both modes
  document.body.style.background = `linear-gradient(180deg, ${bg1}, ${bg2})`;
  unlock('paletteStylist');
  renderAchievements();
}
/* wire palette buttons */
document.querySelectorAll('[data-palette]').forEach(btn => {
  btn.addEventListener('click', ()=> setPalette(btn.dataset.palette));
});
/* load saved palette */
if(state.palette) setPalette(state.palette);

/* ======== DARK MODE ======== */
document.getElementById('toggleDark').addEventListener('click', ()=>{
  document.body.classList.toggle('dark');
  unlock('nightOwl');
});

/* ======== LANGUAGE ======== */
/* apply saved lang from state */
if(state.lang) {
  document.getElementById('langSelect').value = state.lang;
  document.getElementById('langSmall').value = state.lang;
}
applyLanguage();

/* small controls also set language */
document.getElementById('langSelect').addEventListener('change', e => { state.lang = e.target.value; saveState(); applyLanguage(); renderAchievements(); });
document.getElementById('langSmall').addEventListener('change', e => { state.lang = e.target.value; saveState(); applyLanguage(); renderAchievements(); });

/* ======== APUNTS: calculadores simples ======== */
document.getElementById('btnCalcGL').addEventListener('click', ()=>{
  const g = Number(document.getElementById('g1').value);
  const ml = Number(document.getElementById('v1').value);
  const out = document.getElementById('res1');
  if(!g || !ml){ out.innerText = state.lang==='ca'?'Introdueix valors v√†lids.':'Introduce valores v√°lidos.'; return; }
  const L = ml/1000;
  const c = g / L;
  out.innerText = c.toFixed(2) + ' g/L';
  awardPoints(5);
  // unlock readNotes if first time
  unlock('readNotes');
});
document.getElementById('btnCalcPct').addEventListener('click', ()=>{
  const s = Number(document.getElementById('sm1').value);
  const d = Number(document.getElementById('dm1').value);
  const out = document.getElementById('res2');
  if(isNaN(s) || isNaN(d) || (s+d)===0){ out.innerText = state.lang==='ca'?'Dades inv√†lides':'Datos inv√°lidos'; return; }
  const pct = (s/(s+d))*100;
  out.innerText = pct.toFixed(2) + ' %';
  awardPoints(3);
});

/* ======== PROBLEMES: llarga llista (20+) ======== */
const PROBLEMS = [
  {q:"Calcula la concentraci√≥ en g/L si tens 30 g de solut en 600 ml.", sol:"50.00", hint:"600 ml = 0.6 L ‚Üí 30/0.6 = 50 g/L", steps:"600 ml = 0.6 L; 30 √∑ 0.6 = 50 g/L"},
  {q:"Quin % en massa t√© una dissoluci√≥ amb 10 g de solut i 100 g de dissolvent?", sol:"9.09", hint:"Total 110 g ‚Üí 10/110 √ó100 = 9.09%", steps:"Total = 110 g; 10/110 = 0.0909 ‚Üí 9.09%"},
  {q:"5 g NaCl en 250 cm¬≥. Quina concentraci√≥ g/L?", sol:"20.00", hint:"250 cm¬≥ = 0.25 L ‚Üí 5/0.25 = 20 g/L", steps:"250 cm¬≥ = 0.25 L; 5 √∑ 0.25 = 20 g/L"},
  {q:"Preparar 400 cm3 de soluci√≥ de 12 g/L. Quants grams cal?", sol:"4.80", hint:"0.4 L √ó 12 g/L = 4.8 g", steps:"0.4 √ó 12 = 4.8 g"},
  {q:"35 g de sucre en 120 g d'aigua. Quin % en massa?", sol:"22.58", hint:"Total 155 g ‚Üí 35/155 = 0.2258 ‚Üí 22.58%", steps:"35/155√ó100 = 22.58%"},
  {q:"60 g solut en 2 L de dissoluci√≥. Quants g/L?", sol:"30.00", hint:"60/2 = 30 g/L", steps:"60 √∑ 2 = 30 g/L"},
  {q:"Tens 15 g en 250 ml. g/L?", sol:"60.00", hint:"250 ml = 0.25 L ‚Üí 15/0.25 = 60 g/L", steps:"15 √∑ 0.25 = 60 g/L"},
  {q:"Si tens 100 ml d'una soluci√≥ al 10% v/v, quant volum de solut hi ha?", sol:"10.00", hint:"10% de 100 ml = 10 ml", steps:"100 √ó 0.10 = 10 ml"},
  {q:"10 g solut + 90 g dissolvent. % en massa?", sol:"10.00", hint:"Total 100 g ‚Üí 10%", steps:"10/100√ó100 = 10%"},
  {q:"Es dissolen 2 g de sal en 98 g d'aigua. % massa?", sol:"2.00", hint:"Total 100 g ‚Üí 2%", steps:"2/100√ó100 = 2%"},
  {q:"Quants grams hi ha en 750 ml d'una soluci√≥ de 20 g/L?", sol:"15.00", hint:"0.75 L √ó 20 g/L = 15 g", steps:"0.75 √ó 20 = 15 g"},
  {q:"Volum total 500 ml. Si 50 g de solut, quants g/L?", sol:"100.00", hint:"0.5 L ‚Üí 50/0.5 = 100 g/L", steps:"50 √∑ 0.5 = 100 g/L"},
  {q:"80 g solut en 320 g dissoluci√≥ total. % massa?", sol:"25.00", hint:"80/320 = 0.25 ‚Üí 25%", steps:"80/320√ó100 = 25%"},
  {q:"5 g en 1000 ml. g/L?", sol:"5.00", hint:"1 L ‚Üí 5 g/L", steps:"5 √∑ 1 = 5 g/L"},
  {q:"Volum 250 ml, vol% = 40%. Quants ml de solut?", sol:"100.00", hint:"0.4 √ó 250 = 100 ml", steps:"250 √ó 0.4 = 100 ml"},
  {q:"Si desitges 1 L de 5 g/L, quants grams necessites?", sol:"5.00", hint:"1 √ó 5 = 5 g", steps:"1 L √ó 5 g/L = 5 g"},
  {q:"S'ha mesurat 12 g en 0.3 L. Quina √©s la concentraci√≥?", sol:"40.00", hint:"12/0.3 = 40 g/L", steps:"12 √∑ 0.3 = 40 g/L"},
  {q:"Prepares 600 ml al 15% massa i vols saber grams de solut (suposa densitat igual), quants grams?", sol:"90.00", hint:"15% de 600 g ‚âà 90 g", steps:"600 √ó 0.15 = 90 g"},
  {q:"Si una soluci√≥ √©s 2% massa i tens 250 g total, quants grams de solut?", sol:"5.00", hint:"250 √ó 0.02 = 5 g", steps:"250 √ó 0.02 = 5 g"},
  {q:"Prepares 250 ml de soluci√≥ de 8 g/L. Quins grams necessites?", sol:"2.00", hint:"0.25 √ó 8 = 2 g", steps:"0.25 √ó 8 = 2 g"},
  {q:"Si vols diluir 100 ml del 20% al 10% (mantens solut), quin ser√† el volum final?", sol:"200.00", hint:"massa solut constant: 20%√ó100 = 10 g. Per 10 g en 10%, volum = 100 ml ‚Üí 200 ml", steps:"(20%√ó100)/10% = 200 ml"}
];

function renderProblems(){
  const area = document.getElementById('problemesArea');
  area.innerHTML = '';
  PROBLEMS.forEach((p,i)=>{
    const div = document.createElement('div');
    div.className = 'card';
    div.innerHTML = `<h3>Problema ${i+1}</h3>
      <p>${p.q}</p>
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <input id="probInp${i}" placeholder="${state.lang==='ca'?'La teva resposta':'Tu respuesta'}">
        <button class="btn" id="probBtn${i}">${state.lang==='ca'?'Comprovar':'Comprobar'}</button>
        <button class="btn ghost" id="probHint${i}">${state.lang==='ca'?'Pista':'Pista'}</button>
      </div>
      <div id="probOut${i}" class="small" style="margin-top:8px"></div>`;
    area.appendChild(div);
    document.getElementById(`probBtn${i}`).addEventListener('click', ()=>{
      const val = (document.getElementById(`probInp${i}`).value||'').toString().trim().replace(',','.');
      const out = document.getElementById(`probOut${i}`);
      if(!val){ out.innerText = state.lang==='ca'?'Introdueix una resposta':'Introduce una respuesta'; return; }
      // compare numeric tolerance
      if(!isNaN(p.sol)){
        const num = Number(val);
        if(Math.abs(num - Number(p.sol)) <= 0.5){ out.innerText = state.lang==='ca'?'Correcte!':'¬°Correcto!'; awardPoints(8); state.achievements.problemSolver.times = (state.achievements.problemSolver.times||0) + 1; if(state.achievements.problemSolver.times >= 5) unlock('problemSolver'); saveState(); renderAchievements(); }
        else out.innerText = (state.lang==='ca'?'No exacte. Soluci√≥: ':'No exacto. Soluci√≥n: ') + p.sol;
      } else {
        if(val.toLowerCase() === p.sol.toLowerCase()){ out.innerText = state.lang==='ca'?'Correcte!':'¬°Correcto!'; awardPoints(8); }
        else out.innerText = (state.lang==='ca'?'Soluci√≥: ':'Soluci√≥n: ') + p.sol;
      }
    });
    document.getElementById(`probHint${i}`).addEventListener('click', ()=>{
      document.getElementById(`probOut${i}`).innerText = (state.lang==='ca'?'Pista: ':'Pista: ') + p.hint;
    });
  });
}
renderProblems();

/* ======== JOCS: Drag & Drop (millorat) ======== */
function startMatch(){
  showSection('jocs'); // keep jocs visible
  const area = document.getElementById('gameArea'); area.innerHTML = '';
  const terms = [
    {t:'Solut', d:'Subst√†ncia que es dissol (p. ex. sal)'},
    {t:'Dissolvent', d:'Subst√†ncia que dissol (p. ex. aigua)'},
    {t:'g/L', d:'grams de solut per litre de dissoluci√≥'},
    {t:'% massa', d:'(massa solut / massa total) √ó 100'}
  ];
  const defs = shuffle(terms.map(x=>x.d));
  const left = document.createElement('div'); left.className = 'col';
  terms.forEach(term => {
    const card = document.createElement('div'); card.className='card'; card.style.marginBottom='8px';
    card.innerHTML = `<b>${term.t}</b><div class="match-box" data-term="${term.t}"></div>`;
    left.appendChild(card);
  });
  const right = document.createElement('div'); right.className='col';
  defs.forEach(d => {
    const el = document.createElement('div'); el.className='draggable'; el.draggable=true; el.innerText=d;
    el.addEventListener('dragstart', ev => { ev.dataTransfer.setData('text/plain', d); ev.dataTransfer.effectAllowed='move'; });
    right.appendChild(el);
  });
  const wrap = document.createElement('div'); wrap.className='match-wrap';
  wrap.appendChild(left); wrap.appendChild(right);
  area.appendChild(wrap);

  // attach drop handlers
  area.querySelectorAll('.match-box').forEach(box=>{
    box.addEventListener('dragover', e=>{ e.preventDefault(); box.classList.add('dragover'); });
    box.addEventListener('dragleave', e=>{ box.classList.remove('dragover'); });
    box.addEventListener('drop', e=>{ e.preventDefault(); box.classList.remove('dragover'); const txt = e.dataTransfer.getData('text/plain'); box.innerHTML = `<div>${txt}</div>`; box.dataset.assigned = txt; });
  });

  // check button
  const chk = document.createElement('button'); chk.className='btn'; chk.innerText = state.lang==='ca'?'Comprovar':'Comprobar';
  chk.addEventListener('click', ()=>{
    let ok=0;
    area.querySelectorAll('.match-box').forEach(b=>{
      const term = b.dataset.term;
      const ass = (b.dataset.assigned || '').toLowerCase();
      if(matchCheck(term, ass)) ok++;
    });
    const matchres = document.createElement('p'); matchres.className='small'; matchres.style.marginTop='8px';
    matchres.innerText = `${ok}/4 ${state.lang==='ca'?'correctes.':'correctas.'}`;
    area.appendChild(matchres);
    if(ok===4){ awardPoints(10); unlock('matchMaster'); alert(state.lang==='ca'?'Perfecte! Has relacionat tot.':'¬°Perfecto! Has relacionado todo.'); }
  });
  area.appendChild(chk);
}

function matchCheck(term, assigned){
  if(!assigned) return false;
  if(term === 'Solut') return assigned.includes('dissol');
  if(term === 'Dissolvent') return assigned.includes('dissol') && !assigned.includes('solut');
  if(term === 'g/L') return assigned.includes('litre') || assigned.includes('g/l') || assigned.includes('per litre');
  if(term === '% massa') return assigned.includes('massa');
  return false;
}

/* ======== JOCS: R√†fega de c√†lculs ======== */
let calcRoundCount = 0;
function startCalcQuiz(){
  showSection('jocs');
  const area = document.getElementById('gameArea'); area.innerHTML = '';
  calcRoundCount = 0;
  newCalcQuestion();
}
function newCalcQuestion(){
  const area = document.getElementById('gameArea'); area.innerHTML = '';
  const g = rand(5,80); const ml = rand(100,1500); const ans = g / (ml/1000);
  const card = document.createElement('div'); card.className='card';
  card.innerHTML = `<h3>Quina concentraci√≥?</h3><p class="small">${g} g de solut en ${ml} ml de dissoluci√≥ ‚Üí ? g/L</p>
    <input id="calcAns" placeholder="Resposta (g/L)">
    <div style="height:8px"></div>
    <div style="display:flex;gap:8px"><button class="btn" id="checkCalc">Comprovar</button><button class="btn ghost" id="skipCalc">Salt</button></div>
    <p id="calcMsg" class="small" style="margin-top:8px"></p>`;
  area.appendChild(card);
  document.getElementById('checkCalc').addEventListener('click', ()=>{
    const v = Number(document.getElementById('calcAns').value);
    const msg = document.getElementById('calcMsg');
    if(Math.abs(v - ans) <= 0.6){ calcRoundCount++; awardPoints(5); msg.innerText = state.lang==='ca'?'Correcte!':'¬°Correcto!'; if(calcRoundCount>=10){ alert(state.lang==='ca'?'Has completat la r√†fega!':'¬°Has completado la r√°faga!'); calcRoundCount=0; unlock('quickCalc'); } else newCalcQuestion(); }
    else { msg.innerText = (state.lang==='ca'?'No exacte. Soluci√≥: ':'No exacto. Soluci√≥n: ') + ans.toFixed(2); resetStreak(); }
  });
  document.getElementById('skipCalc').addEventListener('click', ()=> newCalcQuestion());
}

/* ======== JOCS: LAB SIMULATOR ======== */
function startLab(){
  showSection('jocs');
  const area = document.getElementById('gameArea'); area.innerHTML = '';
  const target = rand(5,18); // g/L target
  const card = document.createElement('div'); card.className='card';
  card.innerHTML = `<h3>Laboratori</h3><p class="small">Objectiu: ${target} g/L</p>
    <div style="display:flex;gap:8px">
      <input id="labG" type="number" placeholder="grams solut">
      <input id="labML" type="number" placeholder="ml dissoluci√≥">
      <button class="btn" id="labCheck">Comprovar</button>
    </div>
    <p id="labOut" class="small" style="margin-top:8px"></p>`;
  area.appendChild(card);
  document.getElementById('labCheck').addEventListener('click', ()=>{
    const g = Number(document.getElementById('labG').value);
    const ml = Number(document.getElementById('labML').value);
    const out = document.getElementById('labOut');
    if(!g||!ml){ out.innerText = state.lang==='ca'?'Introdueix valors v√†lids':'Introduce valores v√°lidos'; return; }
    const got = g / (ml/1000);
    if(Math.abs(got - target) <= 0.5){ out.innerText = state.lang==='ca'?'Perfecte! Objectiu assolit':'¬°Perfecto! Objetivo alcanzado'; awardPoints(12); unlock('labWizard'); }
    else out.innerText = (state.lang==='ca'?'Tens ':'Tienes ') + got.toFixed(2) + ' g/L (objectiu ' + target + ' g/L)'; resetStreak();
  });
}

/* ======== JOCS: MEMORY EDUCATIU ======== */
function startMemory(){
  showSection('jocs');
  const area = document.getElementById('gameArea');
  area.innerHTML = '';
  const cards = [
    'Solut','Dissolvent','g/L','% massa','Solut','Dissolvent','g/L','% massa'
  ].sort(()=>Math.random()-0.5);
  const board = document.createElement('div'); board.className='board';
  const stateMem = {first:null,second:null,lock:false,matches:0,start:Date.now()};
  cards.forEach((c,i)=>{
    const tile = document.createElement('div'); tile.className='tile'; tile.innerText='‚ùì'; tile.dataset.val = c;
    tile.addEventListener('click', ()=>{
      if(stateMem.lock || tile.classList.contains('revealed')) return;
      tile.classList.add('revealed'); tile.innerText = tile.dataset.val;
      if(!stateMem.first) stateMem.first = tile;
      else if(!stateMem.second && tile!==stateMem.first) stateMem.second = tile;
      if(stateMem.first && stateMem.second){
        if(stateMem.first.dataset.val === stateMem.second.dataset.val){
          stateMem.first.classList.add('matched'); stateMem.second.classList.add('matched');
          stateMem.first = stateMem.second = null; stateMem.matches++;
          awardPoints(8);
          if(stateMem.matches >= 4){ const elapsed = Math.round((Date.now()-stateMem.start)/1000); awardPoints(Math.max(0, 50 - elapsed)); alert(state.lang==='ca'?'Has completat el memory!':'¬°Has completado el memory!'); }
        } else {
          stateMem.lock = true; resetStreak();
          setTimeout(()=>{ stateMem.first.classList.remove('revealed'); stateMem.first.innerText='‚ùì'; stateMem.second.classList.remove('revealed'); stateMem.second.innerText='‚ùì'; stateMem.first = stateMem.second = null; stateMem.lock = false; }, 900);
        }
      }
    });
    board.appendChild(tile);
  });
  area.appendChild(board);
}

/* ======== JOCS: TIMED CHALLENGE ======== */
function startTimed(){
  showSection('jocs');
  const area = document.getElementById('gameArea'); area.innerHTML = '';
  let timeLeft = 60, solved = 0;
  const card = document.createElement('div'); card.className='card';
  card.innerHTML = `<h3>Repte cronometrat</h3><p class="small">Soluciona 5 preguntes en 60s.</p><div id="timedQ"></div><p id="timedOut" class="small"></p>`;
  area.appendChild(card);
  const timerId = setInterval(()=>{ timeLeft--; document.getElementById('timedOut').innerText = (state.lang==='ca'?'Temps: ':'Tiempo: ') + timeLeft + 's'; if(timeLeft<=0){ clearInterval(timerId); alert(state.lang==='ca'?'Temps acabat':'Se acab√≥ el tiempo'); } },1000);
  next();
  function next(){
    if(solved>=5){ clearInterval(timerId); alert(state.lang==='ca'?'Repte completat!':'¬°Reto completado!'); awardPoints(20); return; }
    const g = rand(5,60); const ml = rand(100,1200); const ans = g/(ml/1000);
    document.getElementById('timedQ').innerHTML = `<p>${g} g en ${ml} ml ‚Üí ? g/L</p><input id="tans" placeholder="Resposta"><div style="height:8px"></div><button class="btn" id="tcheck">Comprovar</button>`;
    document.getElementById('tcheck').onclick = ()=>{ const u = Number(document.getElementById('tans').value); if(Math.abs(u-ans)<=0.7){ solved++; awardPoints(6); next(); } else { alert(state.lang==='ca'?'No correcte':'No correcto'); resetStreak(); } };
  }
}

/* ======== JOCS: FILL THE BLANK ======== */
function startFill(){
  showSection('jocs');
  const area = document.getElementById('gameArea'); area.innerHTML = '';
  const html = `<div class="card"><h3>Omple els buits</h3><p class="small">Completa: g/L = ____ √∑ ____</p>
    <input id="fb1" placeholder="grams..." style="width:130px;display:inline-block">
    <input id="fb2" placeholder="litres..." style="width:130px;display:inline-block">
    <div style="height:8px"></div><button class="btn" id="fbCheck">Comprovar</button><p id="fbOut" class="small" style="margin-top:8px"></p></div>`;
  area.innerHTML = html;
  document.getElementById('fbCheck').addEventListener('click', ()=>{
    const a = document.getElementById('fb1').value.toLowerCase(), b = document.getElementById('fb2').value.toLowerCase();
    if((a.includes('g')||a.includes('grams')) && (b.includes('l')||b.includes('litre'))) { document.getElementById('fbOut').innerText = state.lang==='ca'?'Correcte!':'¬°Correcto!'; awardPoints(6); } else { document.getElementById('fbOut').innerText = state.lang==='ca'?'Prova amb grams i litres':'Prueba con gramos y litros'; resetStreak(); }
  });
}

/* ======== UTIL: shuffle, rand ======== */
function shuffle(a){ return a.sort(()=>Math.random()-0.5); }
function rand(min,max){ return Math.floor(Math.random()*(max-min+1))+min; }

/* ======== Wire up game tiles ======== */
document.getElementById('tileMatch').addEventListener('click', startMatch);
document.getElementById('tileCalc').addEventListener('click', startCalcQuiz);
document.getElementById('tileLab').addEventListener('click', startLab);
document.getElementById('tileMemory').addEventListener('click', startMemory);
document.getElementById('tileTimed').addEventListener('click', startTimed);
document.getElementById('tileFill').addEventListener('click', startFill);

/* ======== Misc: quick helpers ======== */
document.getElementById('btnCalcGL').addEventListener('keydown', e => { if(e.key==='Enter') document.getElementById('btnCalcGL').click(); });
document.getElementById('logoMark').addEventListener('dblclick', ()=> { alert(state.lang==='ca'?'Doble clic detectat!':'¬°Doble clic detectado!'); });

/* ======== INIT APPLY SAVED PALETTE & LANG & RENDER ======== */
if(localStorage.getItem(STORE_PREFIX+'palette')) setTimeout(()=> setPalette(localStorage.getItem(STORE_PREFIX+'palette')), 10);
function setPalette(p){
  state.palette = p; localStorage.setItem(STORE_PREFIX+'palette', p);
  let bg1,bg2,accent,accent2;
  if(p==='menta'){ bg1='#e6fbf7'; bg2='#d3fff6'; accent='#48d8b4'; accent2='#7afbe6'; }
  else if(p==='magma'){ bg1='#fff3ee'; bg2='#fff6ec'; accent='#ff5a3d'; accent2='#ffb36e'; }
  else { bg1='#f4f7ff'; bg2='#ecf1ff'; accent='#4d6bff'; accent2='#5dd4c6'; }
  document.documentElement.style.setProperty('--bg1', bg1);
  document.documentElement.style.setProperty('--bg2', bg2);
  document.documentElement.style.setProperty('--accent', accent);
  document.documentElement.style.setProperty('--accent2', accent2);
  document.documentElement.style.setProperty('--accent-gradient', `linear-gradient(90deg, ${accent}, ${accent2})`);
  document.body.style.background = `linear-gradient(180deg, ${bg1}, ${bg2})`;
  unlock('paletteStylist');
  renderAchievements();
}
document.querySelectorAll('button[data-palette]').forEach(b => b.addEventListener('click', ()=> setPalette(b.dataset.palette)));

/* ======== Explorer check (visit all sections) ======== */
function checkExplorer(){
  const sections = ['apunts','jocs','problemes','logros','config'];
  let visited = 0;
  sections.forEach(s => { if(localStorage.getItem(STORE_PREFIX+'visited_'+s) === '1') visited++; });
  if(visited === sections.length) unlock('explorer');
}
document.querySelectorAll('nav button[data-target]').forEach(b => b.addEventListener('click', ()=> localStorage.setItem(STORE_PREFIX+'visited_'+b.dataset.target, '1')));

/* ======== LOAD LANG & RENDER ======== */
function applyLanguage(){ // update text nodes dynamic
  document.getElementById('titleTxt').innerText = T[state.lang].title;
  document.getElementById('subtitleTxt').innerText = T[state.lang].subtitle;
  document.getElementById('notesIntro').innerText = T[state.lang].notesIntro;
  document.getElementById('statusTitle').innerText = T[state.lang].status;
  document.getElementById('btnCalcGL').innerText = T[state.lang].btnCalculate;
  document.getElementById('btnCalcPct').innerText = T[state.lang].btnPct;
  // update problem UI to reflect language labels
  renderProblems();
  renderAchievements();
  renderStatus();
}
applyLanguage();

/* ======== Save on unload ======== */
window.addEventListener('beforeunload', saveState);

  </script>
</body>
</html>
